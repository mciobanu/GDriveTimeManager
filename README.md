# Google Drive Time Manager

The main purpose of this is to set the changed time for Google Drive folders such that their "modified" time as
shown on the site reflects the latest time a file within that folder was changed, looking recursively at all the files.
If a folder is empty, its time will be set to January 1st 1970, 12:00 UTC.

The default behavior for a folder's "modified" time is to reflect when the user created or last changed the folder
itself, while files or folders in it have no impact on it.

Changed times can also be set for files.

Another purpose is to serve as an example of using *Google Apps Script* to implement custom functionality in a
spreadsheet.

## Example
We have these files and folders:
* `/dir1/`, changed at 07:00
* `/dir1/dir2/`, changed at 08:00
* `/dir1/dir2/file1`, changed at 09:00
* `/dir1/file2`, changed at 10:00
* `/dir1/dir3/`, changed at 11:00

(To keep things shorter, all times are supposed to be in the same day, so the date is not shown.)

After running the script, we'll have these (changes in **bold**):
* `/dir1/`, changed at **10:00**
* `/dir1/dir2/`, changed at **09:00**
* `/dir1/dir2/file1`, changed at 09:00
* `/dir1/file2`, changed at 10:00
* `/dir1/dir3/`, changed at **1970-01-01 12:00 UTC**

## Limitations
* The script wasn't tested with shared drives, and it's unclear what to expect in such a scenario.
* Shortcuts are currently skipped, as their change time seems best ignored.
* For folders that have other owners, we don't try to set the date. (It doesn't seem to work, anyway.)

## Installation
* Go to [Google Drive](https://drive.google.com/drive/) and create a new spreadsheet. Let's say you call it *Drive
  Time Manager* and you put it in the root of your *Drive*, but you can give it any name and put it in some subfolder,
  just make sure you remember where you put it and how you called it.
* With the new spreadsheet open, open the *Extensions* menu and click on *App Script*.
* In the new browser window/tab that opens, give a meaningful name to the project, like *Drive Time Manager*, and then
  replace the autogenerated code with the content of the file *google-drive-set-time.js*, which you can get
  from [here](https://raw.githubusercontent.com/mciobanu/GDriveTimeManager/main/google-drive-set-time.js).
* On the left, click on the "+" next to *Services* and add the *Drive API*, version *v2* (the only one available
  as of this writing)
* Click on the *Save* button, then close both the *App Script* tab and your new spreadsheet's tab.
* Reopen the spreadsheet. It should be changed in this way:
  * It should have a sheet called *Folders* and one called *Files*, with the background color set
    for some cells. Some of these also have text, which shouldn't be changed.
  * It should have a custom menu called *Modification times*, as the last menu entry

## Usage
You can run the script for the whole drive or just for some folders. In *Column A* you can specify folders by name
or by ID, under the automatically created cells, and you can add more rows if you need them.

A reason to give IDs is when you have multiple folders with the same name. Then, when you try to run the script,
error messages will be created in *Column B* for such folders, and you can see the full path and the ID there and
choose the one you want.

If you don't enter any name or ID, the script runs on the whole drive.

To run the script, use the newly added custom menu (*Set time for specified folders*, under *Modification times*).
Note that the first time you run it, you need to give it access to your drive, which requires choosing a *gMail*
account and clicking on the *Advanced* link to enable access rights, as it is not verified by Google. (It would be
the same for whatever scripts you create that access *Drive*.) You may be presented with a similar request a number of
times, as there are a number of APIs and permission seems to be granted one at a time.

**Note:** Google makes broad assumptions about what the code might do based on a coarse code analysis, and doesn't
seem to allow fine-grained permissions. As such, you're granting permissions for *See, edit, create, and delete all
of your Google Drive files*, *View your Google Drive apps*, or *See, edit, create, and delete all your Google Sheets
spreadsheets* when what really happens is that the only file whose content changes is the spreadsheet running the
script, and no file is ever deleted. The only thing that ever changes for the other files and folders is the *change
time*, and only when you request it. (Also, a look at the code will reveal that it contains nothing for file deletion.)

**Note**: The request for granting permissions can come at a random moment, stopping the script from setting up the
sheets and leaving them in an inconsistent state. Should that happen, you can rename the affected sheet and start
again, for example by closing the spreadsheet and reopening.

While running, the script logs what it does in the spreadsheet. Feel free to delete the log or parts of it after that.

**Do not** change the content of the "label" cells, which got created automatically, as the script uses them to
determine where names and IDs begin and end.

If you rename the *Folders* or *Files* sheets, they will be recreated. This way it's easier to start over or keep
a snapshot of your data at some point in time. This can also help with you changing the wrong cells or potential
bugs in the script.

### Menu entries

* *Validate folder data*: Takes names and IDs in *Column A* and makes sure they are valid (they may not exist or a
  name may refer to multiple folders). The results are put in *Column B*. The main reason to use IDs is that you might
  have multiple folders with the same name and don't want to process them all. The IDs can be copied from *Column B*,
  after getting the error of having multiple folders with the same name.
  * **Note**: If no names or IDs are entered, the assumption is that we process the whole drive.
* *Set time for specified folders*: Goes through the folders given by name or ID in colum *A* and sets the change time
  as the most recent time of the files inside that folder (directly or somewhere in the folder tree). Validation is
  run before it, and the script doesn't proceed if there are any errors.
* *List content of specified  folders*: Generates the list with the files in the given folders and puts it in the log area.
* *Validate file data*: Like *Validate folder data* but for files: names and IDs must exist and be unique. Unlike for
  folders, you need to specify some files. (If a reason becomes apparent for set the change time to the same value
  for all the files, this might get implemented.) The results are now in *Column C*, as *Column B* is used to specify
  the new date for a particular file. The formats you can use for dates depend on your locale settings. Another thing
  that is checked here is that there is a 1:1 correspondence between dates and names or IDs.
* *Set time for specified files*: Calls the validation and, if all is fine, sets the times as instructed.

## Notes for developers
* The dependency on `@types/google-apps-script` is just to help auto-completion, when editing files locally.
* Currently, everything is in one file, which is easy to install but rather unwieldy to work with. This can be changed,
  if it seems useful

## Future work
* Perhaps add some options, like whether to ignore the shortcuts or not. These could be put in a dedicated sheet.
* Maybe add a "dry-run" mode.
